{{#*inline "title"}}Rate Limiting{{/inline}}
{{#*inline "current_page"}}rate-limiting{{/inline}}

{{#*inline "content"}}
<!-- Rate Limiting Configuration -->
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">Rate Limiting</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item">Security</li>
                    <li class="breadcrumb-item active">Rate Limiting</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <div class="form-check form-switch form-check-reverse">
                <input class="form-check-input" type="checkbox" id="rateLimitEnabled" checked>
                <label class="form-check-label" for="rateLimitEnabled">
                    Rate Limiting Enabled
                </label>
            </div>
            <button class="btn btn-primary ms-3" onclick="saveRateLimitConfig()">
                <i class="bi bi-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Rate Limit Overview -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Queries Throttled</h6>
                        <div class="h3 mb-0">{{throttled_queries}}</div>
                        <small class="text-warning">Last 24 hours</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-speedometer text-warning" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Blocked Clients</h6>
                        <div class="h3 mb-0">{{blocked_clients}}</div>
                        <small class="text-danger">Currently blocked</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-person-x text-danger" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Active Limits</h6>
                        <div class="h3 mb-0">{{active_limits}}</div>
                        <small class="text-info">Configured rules</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-list-check text-info" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Avg QPS</h6>
                        <div class="h3 mb-0">{{avg_qps}}</div>
                        <small class="text-success">Per client</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-activity text-success" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Rate Limits -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Global Rate Limits</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Maximum Queries Per Second (Global)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="globalQPS" value="10000" min="100" max="1000000">
                    <span class="input-group-text">QPS</span>
                </div>
                <small class="text-muted">Total queries allowed across all clients</small>
            </div>
            <div class="col-md-6">
                <label class="form-label">Maximum Queries Per Client</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="perClientQPS" value="100" min="1" max="10000">
                    <span class="input-group-text">QPS</span>
                </div>
                <small class="text-muted">Maximum queries per second per IP address</small>
            </div>
            <div class="col-md-4">
                <label class="form-label">Burst Size</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="burstSize" value="50" min="1" max="1000">
                    <span class="input-group-text">queries</span>
                </div>
                <small class="text-muted">Allow short bursts up to this size</small>
            </div>
            <div class="col-md-4">
                <label class="form-label">Window Size</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="windowSize" value="60" min="1" max="3600">
                    <span class="input-group-text">seconds</span>
                </div>
                <small class="text-muted">Time window for rate calculations</small>
            </div>
            <div class="col-md-4">
                <label class="form-label">Block Duration</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="blockDuration" value="300" min="60" max="86400">
                    <span class="input-group-text">seconds</span>
                </div>
                <small class="text-muted">How long to block violating clients</small>
            </div>
        </div>
    </div>
</div>

<!-- Rate Limit Rules -->
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Custom Rate Limit Rules</h5>
            </div>
            <div class="col-auto">
                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                    <i class="bi bi-plus"></i> Add Rule
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Match</th>
                        <th>Limit</th>
                        <th>Window</th>
                        <th>Action</th>
                        <th>Hits</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each rate_rules}}
                    <tr>
                        <td>
                            <div class="fw-semibold">{{name}}</div>
                            <small class="text-muted">{{description}}</small>
                        </td>
                        <td><span class="badge bg-info">{{type}}</span></td>
                        <td><code>{{match_pattern}}</code></td>
                        <td>{{limit}} QPS</td>
                        <td>{{window}}s</td>
                        <td>
                            <span class="badge bg-{{action_color}}">{{action}}</span>
                        </td>
                        <td>{{hit_count}}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" {{#if enabled}}checked{{/if}}>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editRule('{{rule_id}}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteRule('{{rule_id}}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Adaptive Rate Limiting -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Adaptive Rate Limiting</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="adaptiveEnabled" checked>
                    <label class="form-check-label" for="adaptiveEnabled">
                        Enable Adaptive Rate Limiting
                    </label>
                </div>
                <p class="text-muted">Automatically adjust rate limits based on server load and traffic patterns.</p>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">CPU Threshold</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="80" min="50" max="95">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Memory Threshold</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="85" min="50" max="95">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Reduction Factor</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="0.5" min="0.1" max="0.9" step="0.1">
                            <span class="input-group-text">×</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Recovery Rate</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="10" min="1" max="50">
                            <span class="input-group-text">%/min</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Exponential Backoff</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="backoffEnabled" checked>
                    <label class="form-check-label" for="backoffEnabled">
                        Enable Exponential Backoff
                    </label>
                </div>
                <p class="text-muted">Progressively increase penalties for repeat offenders.</p>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Initial Penalty</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="60" min="10" max="600">
                            <span class="input-group-text">seconds</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Backoff Multiplier</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="2" min="1.5" max="5" step="0.5">
                            <span class="input-group-text">×</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Max Penalty</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="86400" min="3600" max="604800">
                            <span class="input-group-text">seconds</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Decay Period</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="24" min="1" max="168">
                            <span class="input-group-text">hours</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Currently Blocked Clients -->
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Currently Blocked Clients</h5>
            </div>
            <div class="col-auto">
                <button class="btn btn-sm btn-outline-danger" onclick="clearAllBlocks()">
                    <i class="bi bi-trash"></i> Clear All
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm">
                <thead class="sticky-top bg-white">
                    <tr>
                        <th>IP Address</th>
                        <th>Reason</th>
                        <th>Queries</th>
                        <th>Blocked At</th>
                        <th>Expires</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each blocked_clients_list}}
                    <tr>
                        <td>{{ip_address}}</td>
                        <td><span class="badge bg-warning">{{reason}}</span></td>
                        <td>{{query_count}}</td>
                        <td>{{blocked_at}}</td>
                        <td>{{expires_in}}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-success" onclick="unblockClient('{{ip_address}}')">
                                <i class="bi bi-unlock"></i> Unblock
                            </button>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Rate Limit Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Rule Name</label>
                        <input type="text" class="form-control" id="ruleName">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Match Type</label>
                        <select class="form-select" id="matchType">
                            <option value="ip">IP Address</option>
                            <option value="subnet">Subnet</option>
                            <option value="domain">Domain</option>
                            <option value="query_type">Query Type</option>
                            <option value="geo">Geographic</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Match Pattern</label>
                        <input type="text" class="form-control" id="matchPattern" placeholder="e.g., 192.168.1.0/24">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rate Limit</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="rateLimit" value="10">
                            <span class="input-group-text">QPS</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Window</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="window" value="60">
                            <span class="input-group-text">seconds</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Action</label>
                        <select class="form-select" id="action">
                            <option value="throttle">Throttle</option>
                            <option value="block">Block</option>
                            <option value="log">Log Only</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Priority</label>
                        <input type="number" class="form-control" id="priority" value="100" min="1" max="999">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">Save Rule</button>
            </div>
        </div>
    </div>
</div>

<script>
function saveRateLimitConfig() {
    showToast('Rate limiting configuration saved', 'success');
}

function editRule(ruleId) {
    showToast('Loading rule details...', 'info');
}

function deleteRule(ruleId) {
    if (confirm('Delete this rate limit rule?')) {
        showToast('Rule deleted', 'success');
    }
}

function saveRule() {
    showToast('Rate limit rule saved', 'success');
    bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
}

function unblockClient(ip) {
    if (confirm(`Unblock client ${ip}?`)) {
        showToast(`Client ${ip} unblocked`, 'success');
    }
}

function clearAllBlocks() {
    if (confirm('Clear all blocked clients?')) {
        showToast('All blocks cleared', 'success');
    }
}

// Update adaptive settings
document.getElementById('adaptiveEnabled').addEventListener('change', function() {
    showToast(`Adaptive rate limiting ${this.checked ? 'enabled' : 'disabled'}`, 'info');
});

document.getElementById('backoffEnabled').addEventListener('change', function() {
    showToast(`Exponential backoff ${this.checked ? 'enabled' : 'disabled'}`, 'info');
});
</script>
{{/inline}}

{{> layout}}