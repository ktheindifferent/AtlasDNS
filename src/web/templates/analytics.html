{{#*inline "title"}}Analytics{{/inline}}
{{#*inline "current_page"}}analytics{{/inline}}

{{#*inline "content"}}
<!-- Analytics Dashboard -->
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">Analytics Dashboard</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active">Analytics</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" data-range="24h">24 Hours</button>
                <button type="button" class="btn btn-outline-primary" data-range="7d">7 Days</button>
                <button type="button" class="btn btn-outline-primary" data-range="30d">30 Days</button>
                <button type="button" class="btn btn-outline-primary" data-range="custom">Custom</button>
            </div>
            <button class="btn btn-primary ms-2" onclick="exportAnalytics()">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{total_queries}}</div>
                        <div class="stat-label">Total Queries</div>
                    </div>
                    <i class="bi bi-activity" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <div class="mt-2">
                    <small><i class="bi bi-arrow-up"></i> 12.5% from last period</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{cache_hit_rate}}%</div>
                        <div class="stat-label">Cache Hit Rate</div>
                    </div>
                    <i class="bi bi-lightning-charge" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <div class="mt-2">
                    <small><i class="bi bi-arrow-up"></i> 3.2% improvement</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{avg_response_time}}ms</div>
                        <div class="stat-label">Avg Response Time</div>
                    </div>
                    <i class="bi bi-speedometer2" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <div class="mt-2">
                    <small><i class="bi bi-arrow-down"></i> 15% faster</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{unique_clients}}</div>
                        <div class="stat-label">Unique Clients</div>
                    </div>
                    <i class="bi bi-people" style="font-size: 2rem; opacity: 0.8;"></i>
                </div>
                <div class="mt-2">
                    <small><i class="bi bi-arrow-up"></i> 8.7% growth</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
    <!-- Query Volume Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Query Volume Over Time</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active">Line</button>
                    <button class="btn btn-outline-secondary">Bar</button>
                    <button class="btn btn-outline-secondary">Area</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="queryVolumeChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Response Codes Distribution -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Response Codes</h5>
            </div>
            <div class="card-body">
                <canvas id="responseCodesChart" height="300"></canvas>
                <div class="mt-3" id="responseCodesDisplay">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-success">NOERROR</span>
                        <span>{{noerror_count}} ({{noerror_percent}}%)</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-warning">NXDOMAIN</span>
                        <span>{{nxdomain_count}} ({{nxdomain_percent}}%)</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-danger">SERVFAIL</span>
                        <span>{{servfail_count}} ({{servfail_percent}}%)</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-info">Other</span>
                        <span>{{other_count}} ({{other_percent}}%)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Analytics -->
<div class="row g-3 mb-4">
    <!-- Query Types -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Query Types</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshQueryTypes()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <canvas id="queryTypesChart" height="250"></canvas>
                <div class="table-responsive mt-3">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="queryTypesTable">
                            <tr>
                                <td><span class="badge bg-primary">A</span></td>
                                <td>{{a_count}}</td>
                                <td>{{a_percent}}%</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-info">AAAA</span></td>
                                <td>{{aaaa_count}}</td>
                                <td>{{aaaa_percent}}%</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-success">CNAME</span></td>
                                <td>{{cname_count}}</td>
                                <td>{{cname_percent}}%</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-warning">MX</span></td>
                                <td>{{mx_count}}</td>
                                <td>{{mx_percent}}%</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-secondary">TXT</span></td>
                                <td>{{txt_count}}</td>
                                <td>{{txt_percent}}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Queried Domains -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Top Domains</h5>
                <select class="form-select form-select-sm" style="width: auto;">
                    <option>Top 10</option>
                    <option>Top 25</option>
                    <option>Top 50</option>
                </select>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>Queries</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="topDomainsTable">
                            {{#each top_domains}}
                            <tr>
                                <td class="text-truncate" style="max-width: 150px;">{{domain}}</td>
                                <td>{{queries}}</td>
                                <td>
                                    {{#if trend_up}}
                                    <i class="bi bi-arrow-up text-success"></i>
                                    {{else}}
                                    <i class="bi bi-arrow-down text-danger"></i>
                                    {{/if}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Geographic Distribution -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Geographic Distribution</h5>
            </div>
            <div class="card-body">
                <div id="geoMap" style="height: 250px;"></div>
                <div class="table-responsive mt-3">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Country</th>
                                <th>Queries</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody id="geoTable">
                            {{#each geo_distribution}}
                            <tr>
                                <td>
                                    <img src="/flags/{{country_code}}.svg" width="20" class="me-2">
                                    {{country}}
                                </td>
                                <td>{{queries}}</td>
                                <td>{{percent}}%</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Response Time Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="responseTimeChart" height="250"></canvas>
                <div class="row mt-3 text-center">
                    <div class="col">
                        <div class="text-muted">P50</div>
                        <div class="h5">{{p50_latency}}ms</div>
                    </div>
                    <div class="col">
                        <div class="text-muted">P90</div>
                        <div class="h5">{{p90_latency}}ms</div>
                    </div>
                    <div class="col">
                        <div class="text-muted">P95</div>
                        <div class="h5">{{p95_latency}}ms</div>
                    </div>
                    <div class="col">
                        <div class="text-muted">P99</div>
                        <div class="h5">{{p99_latency}}ms</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Protocol Usage</h5>
            </div>
            <div class="card-body">
                <canvas id="protocolChart" height="250"></canvas>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-primary"></i> UDP</span>
                            <span>{{udp_percent}}%</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-info"></i> TCP</span>
                            <span>{{tcp_percent}}%</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-success"></i> DoH</span>
                            <span>{{doh_percent}}%</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-warning"></i> DoT</span>
                            <span>{{dot_percent}}%</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-circle-fill text-danger"></i> DoQ</span>
                            <span>{{doq_percent}}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anomaly Detection -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Anomaly Detection</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <strong>2 Anomalies Detected</strong> in the last 24 hours
            </div>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Impact</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each anomalies}}
                    <tr>
                        <td>{{timestamp}}</td>
                        <td><span class="badge bg-{{type_color}}">{{type}}</span></td>
                        <td>{{description}}</td>
                        <td><span class="badge bg-{{impact_color}}">{{impact}}</span></td>
                        <td><span class="badge bg-{{status_color}}">{{status}}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewAnomaly('{{id}}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="dismissAnomaly('{{id}}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Query Volume Chart
    const queryVolumeCtx = document.getElementById('queryVolumeChart').getContext('2d');
    new Chart(queryVolumeCtx, {
        type: 'line',
        data: {
            labels: generateTimeLabels(24),
            datasets: [{
                label: 'Queries',
                data: generateRandomData(24, 1000, 5000),
                borderColor: 'rgb(0, 102, 255)',
                backgroundColor: 'rgba(0, 102, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Response Codes Chart
    const responseCodesCtx = document.getElementById('responseCodesChart').getContext('2d');
    new Chart(responseCodesCtx, {
        type: 'doughnut',
        data: {
            labels: ['NOERROR', 'NXDOMAIN', 'SERVFAIL', 'Other'],
            datasets: [{
                data: [85, 10, 3, 2],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(108, 117, 125, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Query Types Chart
    const queryTypesCtx = document.getElementById('queryTypesChart').getContext('2d');
    new Chart(queryTypesCtx, {
        type: 'bar',
        data: {
            labels: ['A', 'AAAA', 'CNAME', 'MX', 'TXT', 'NS', 'SOA', 'PTR'],
            datasets: [{
                data: [45, 20, 15, 8, 6, 3, 2, 1],
                backgroundColor: 'rgba(0, 102, 255, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Response Time Distribution
    const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
    new Chart(responseTimeCtx, {
        type: 'line',
        data: {
            labels: generateTimeLabels(24),
            datasets: [{
                label: 'P50',
                data: generateRandomData(24, 5, 10),
                borderColor: 'rgb(40, 167, 69)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)'
            }, {
                label: 'P90',
                data: generateRandomData(24, 10, 20),
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)'
            }, {
                label: 'P99',
                data: generateRandomData(24, 20, 50),
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Response Time (ms)'
                    }
                }
            }
        }
    });
    
    // Protocol Usage Chart
    const protocolCtx = document.getElementById('protocolChart').getContext('2d');
    new Chart(protocolCtx, {
        type: 'pie',
        data: {
            labels: ['UDP', 'TCP', 'DoH', 'DoT', 'DoQ'],
            datasets: [{
                data: [60, 15, 12, 8, 5],
                backgroundColor: [
                    'rgba(0, 123, 255, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
});

// Helper functions
function generateTimeLabels(hours) {
    const labels = [];
    const now = new Date();
    for (let i = hours - 1; i >= 0; i--) {
        const time = new Date(now - i * 3600000);
        labels.push(time.getHours() + ':00');
    }
    return labels;
}

function generateRandomData(count, min, max) {
    const data = [];
    for (let i = 0; i < count; i++) {
        data.push(Math.floor(Math.random() * (max - min + 1)) + min);
    }
    return data;
}

function exportAnalytics() {
    showToast('Exporting analytics data...', 'info');
    // Implement export functionality
}

function refreshQueryTypes() {
    showToast('Refreshing query types...', 'info');
    // Implement refresh functionality
}

// Function to update response codes display
function updateResponseCodesDisplay(data) {
    const container = document.getElementById('responseCodesDisplay');
    if (!container) return;
    
    // Clear existing content before adding new data
    container.innerHTML = '';
    
    // Add new data
    const responseTypes = [
        { key: 'noerror', label: 'NOERROR', class: 'bg-success' },
        { key: 'nxdomain', label: 'NXDOMAIN', class: 'bg-warning' },
        { key: 'servfail', label: 'SERVFAIL', class: 'bg-danger' },
        { key: 'other', label: 'Other', class: 'bg-info' }
    ];
    
    responseTypes.forEach((type, index) => {
        const div = document.createElement('div');
        div.className = `d-flex justify-content-between${index < responseTypes.length - 1 ? ' mb-2' : ''}`;
        
        const count = data[type.key + '_count'] || 0;
        const percent = data[type.key + '_percent'] || 0;
        
        div.innerHTML = `
            <span class="badge ${type.class}">${type.label}</span>
            <span>${count} (${percent}%)</span>
        `;
        
        container.appendChild(div);
    });
}

// Example usage for real-time updates
function simulateResponseCodesUpdate() {
    // This would be called when new data arrives
    const mockData = {
        noerror_count: Math.floor(Math.random() * 1000),
        noerror_percent: Math.floor(Math.random() * 100),
        nxdomain_count: Math.floor(Math.random() * 100),
        nxdomain_percent: Math.floor(Math.random() * 20),
        servfail_count: Math.floor(Math.random() * 50),
        servfail_percent: Math.floor(Math.random() * 10),
        other_count: Math.floor(Math.random() * 25),
        other_percent: Math.floor(Math.random() * 5)
    };
    
    updateResponseCodesDisplay(mockData);
}

function viewAnomaly(id) {
    showToast('Loading anomaly details...', 'info');
    // Implement view functionality
}

function dismissAnomaly(id) {
    if (confirm('Are you sure you want to dismiss this anomaly?')) {
        showToast('Anomaly dismissed', 'success');
        // Implement dismiss functionality
    }
}

// Date range selector
document.querySelectorAll('[data-range]').forEach(button => {
    button.addEventListener('click', function() {
        document.querySelectorAll('[data-range]').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const range = this.dataset.range;
        if (range === 'custom') {
            // Show date picker modal
            showToast('Custom date range selector coming soon', 'info');
        } else {
            showToast(`Loading ${range} data...`, 'info');
            // Reload data for selected range
        }
    });
});
</script>
{{/inline}}

{{> layout}}
