{{#*inline "title"}}DNS Firewall{{/inline}}
{{#*inline "current_page"}}firewall{{/inline}}

{{#*inline "content"}}
<!-- DNS Firewall -->
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="page-title">DNS Firewall</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item">Security</li>
                    <li class="breadcrumb-item active">DNS Firewall</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <div class="form-check form-switch form-check-reverse">
                <input class="form-check-input" type="checkbox" id="firewallEnabled" checked>
                <label class="form-check-label" for="firewallEnabled">
                    Firewall Enabled
                </label>
            </div>
            <button class="btn btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                <i class="bi bi-plus-circle"></i> Add Rule
            </button>
        </div>
    </div>
</div>

<!-- Firewall Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Queries Blocked</h6>
                        <div class="h3 mb-0">{{blocked_queries}}</div>
                        <small class="text-danger"><i class="bi bi-arrow-up"></i> 15% today</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-shield-x text-danger" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Active Rules</h6>
                        <div class="h3 mb-0">{{active_rules}}</div>
                        <small class="text-muted">{{custom_rules}} custom</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-list-check text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Threat Feeds</h6>
                        <div class="h3 mb-0">{{threat_feeds}}</div>
                        <small class="text-success">All updated</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-cloud-download text-success" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Block Rate</h6>
                        <div class="h3 mb-0">{{block_rate}}%</div>
                        <small class="text-warning">Last 24h</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-percent text-warning" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firewall Rules -->
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Firewall Rules</h5>
            </div>
            <div class="col-auto">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active">All</button>
                    <button class="btn btn-outline-secondary">Block</button>
                    <button class="btn btn-outline-secondary">Allow</button>
                    <button class="btn btn-outline-secondary">Redirect</button>
                </div>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="importRules()">
                    <i class="bi bi-upload"></i> Import
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="exportRules()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="rulesTable">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" class="form-check-input" id="selectAll">
                        </th>
                        <th>Priority</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Match</th>
                        <th>Action</th>
                        <th>Hits</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each firewall_rules}}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input rule-select" value="{{rule_id}}">
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{priority}}</span>
                        </td>
                        <td>
                            <div class="fw-semibold">{{name}}</div>
                            <small class="text-muted">{{description}}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">{{type}}</span>
                        </td>
                        <td>
                            <code>{{match_pattern}}</code>
                        </td>
                        <td>
                            <span class="badge bg-{{action_color}}">
                                <i class="bi bi-{{action_icon}}"></i> {{action}}
                            </span>
                        </td>
                        <td>{{hit_count}}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" {{#if enabled}}checked{{/if}} 
                                       onchange="toggleRule('{{rule_id}}', this.checked)">
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editRule('{{rule_id}}')" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="testRule('{{rule_id}}')" title="Test">
                                    <i class="bi bi-play"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteRule('{{rule_id}}')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()" disabled id="deleteSelectedBtn">
                Delete Selected
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="disableSelected()" disabled id="disableSelectedBtn">
                Disable Selected
            </button>
        </div>
    </div>
</div>

<!-- Threat Intelligence Feeds -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">Threat Intelligence Feeds</h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-success" onclick="addThreatFeed()">
                            <i class="bi bi-plus"></i> Add Feed
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {{#each threat_feeds_list}}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input" type="checkbox" {{#if enabled}}checked{{/if}}>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">{{name}}</h6>
                                        <small class="text-muted">{{url}}</small>
                                        <div class="mt-1">
                                            <span class="badge bg-{{category_color}}">{{category}}</span>
                                            <span class="badge bg-secondary">{{entries}} entries</span>
                                            <span class="badge bg-info">Updated {{last_update}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="updateFeed('{{feed_id}}')" title="Update Now">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="removeFeed('{{feed_id}}')" title="Remove">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Block Lists -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">Custom Block Lists</h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-success" onclick="createBlockList()">
                            <i class="bi bi-plus"></i> Create List
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="accordion" id="blockListsAccordion">
                    {{#each block_lists}}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#list-{{list_id}}">
                                <div class="d-flex align-items-center w-100">
                                    <i class="bi bi-list-ul me-2"></i>
                                    <span class="fw-semibold">{{name}}</span>
                                    <span class="badge bg-secondary ms-2">{{entries}} entries</span>
                                    <span class="ms-auto me-3">
                                        <span class="badge bg-{{status_color}}">{{status}}</span>
                                    </span>
                                </div>
                            </button>
                        </h2>
                        <div id="list-{{list_id}}" class="accordion-collapse collapse" data-bs-parent="#blockListsAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <textarea class="form-control" rows="5" placeholder="One domain per line">{{domains}}</textarea>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="saveBlockList('{{list_id}}')">
                                    <i class="bi bi-save"></i> Save Changes
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBlockList('{{list_id}}')">
                                    <i class="bi bi-trash"></i> Delete List
                                </button>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security Events Log -->
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Recent Security Events</h5>
            </div>
            <div class="col-auto">
                <select class="form-select form-select-sm" style="width: auto;">
                    <option>Last Hour</option>
                    <option>Last 24 Hours</option>
                    <option>Last 7 Days</option>
                </select>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshEvents()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm">
                <thead class="sticky-top bg-white">
                    <tr>
                        <th>Time</th>
                        <th>Event Type</th>
                        <th>Source IP</th>
                        <th>Domain</th>
                        <th>Rule</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each security_events}}
                    <tr>
                        <td>{{timestamp}}</td>
                        <td><span class="badge bg-{{event_color}}">{{event_type}}</span></td>
                        <td>{{source_ip}}</td>
                        <td>{{domain}}</td>
                        <td>{{rule_name}}</td>
                        <td><span class="badge bg-{{action_color}}">{{action}}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewEventDetails('{{event_id}}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Firewall Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Rule Name</label>
                            <input type="text" class="form-control" id="ruleName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <input type="number" class="form-control" id="rulePriority" value="100" min="1" max="999">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="ruleDescription" rows="2"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Match Type</label>
                            <select class="form-select" id="matchType">
                                <option value="domain">Domain Name</option>
                                <option value="regex">Regular Expression</option>
                                <option value="ip">Source IP</option>
                                <option value="geo">Geographic Location</option>
                                <option value="category">Category</option>
                                <option value="query_type">Query Type</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Match Pattern</label>
                            <input type="text" class="form-control" id="matchPattern" placeholder="e.g., *.malware.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Action</label>
                            <select class="form-select" id="ruleAction">
                                <option value="block">Block</option>
                                <option value="allow">Allow</option>
                                <option value="redirect">Redirect</option>
                                <option value="sinkhole">Sinkhole</option>
                                <option value="log">Log Only</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="redirectTarget" style="display: none;">
                            <label class="form-label">Redirect To</label>
                            <input type="text" class="form-control" id="redirectIP" placeholder="IP Address">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Time Restrictions</label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <input type="time" class="form-control" id="timeFrom" placeholder="From">
                                </div>
                                <div class="col-md-6">
                                    <input type="time" class="form-control" id="timeTo" placeholder="To">
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ruleEnabled" checked>
                                <label class="form-check-label" for="ruleEnabled">
                                    Enable rule immediately
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="logQueries">
                                <label class="form-check-label" for="logQueries">
                                    Log matching queries
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">
                    <i class="bi bi-save"></i> Save Rule
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Handle rule action change
document.getElementById('ruleAction').addEventListener('change', function() {
    const redirectTarget = document.getElementById('redirectTarget');
    if (this.value === 'redirect') {
        redirectTarget.style.display = 'block';
    } else {
        redirectTarget.style.display = 'none';
    }
});

// Select all checkboxes
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.rule-select');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkButtons();
});

// Update bulk action buttons
document.querySelectorAll('.rule-select').forEach(cb => {
    cb.addEventListener('change', updateBulkButtons);
});

function updateBulkButtons() {
    const selected = document.querySelectorAll('.rule-select:checked').length;
    document.getElementById('deleteSelectedBtn').disabled = selected === 0;
    document.getElementById('disableSelectedBtn').disabled = selected === 0;
}

// Firewall functions
function toggleRule(ruleId, enabled) {
    showToast(`Rule ${enabled ? 'enabled' : 'disabled'}`, 'success');
}

function editRule(ruleId) {
    // Load rule data and show modal
    showToast('Loading rule details...', 'info');
}

function testRule(ruleId) {
    showToast('Testing rule...', 'info');
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
        showToast('Rule deleted', 'success');
    }
}

function saveRule() {
    const ruleName = document.getElementById('ruleName').value;
    if (ruleName) {
        showToast('Rule saved successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
    }
}

function deleteSelected() {
    const selected = document.querySelectorAll('.rule-select:checked').length;
    if (confirm(`Delete ${selected} selected rules?`)) {
        showToast(`${selected} rules deleted`, 'success');
    }
}

function disableSelected() {
    const selected = document.querySelectorAll('.rule-select:checked').length;
    showToast(`${selected} rules disabled`, 'success');
}

function importRules() {
    showToast('Opening import dialog...', 'info');
}

function exportRules() {
    showToast('Exporting rules...', 'info');
}

function addThreatFeed() {
    showToast('Opening threat feed configuration...', 'info');
}

function updateFeed(feedId) {
    showToast('Updating threat feed...', 'info');
}

function removeFeed(feedId) {
    if (confirm('Remove this threat feed?')) {
        showToast('Threat feed removed', 'success');
    }
}

function createBlockList() {
    showToast('Creating new block list...', 'info');
}

function saveBlockList(listId) {
    showToast('Block list saved', 'success');
}

function deleteBlockList(listId) {
    if (confirm('Delete this block list?')) {
        showToast('Block list deleted', 'success');
    }
}

function refreshEvents() {
    showToast('Refreshing security events...', 'info');
}

function viewEventDetails(eventId) {
    showToast('Loading event details...', 'info');
}

// Enable/disable firewall
document.getElementById('firewallEnabled').addEventListener('change', function() {
    const status = this.checked ? 'enabled' : 'disabled';
    showToast(`Firewall ${status}`, this.checked ? 'success' : 'warning');
});
</script>
{{/inline}}

{{> layout}}